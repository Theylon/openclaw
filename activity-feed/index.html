<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü¶û OpenClaw Activity Feed</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #ff6b35;
      --success: #3fb950;
      --error: #f85149;
      --info: #58a6ff;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }
    
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .controls {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    select, button, input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
    }
    
    select:hover, button:hover { background: var(--surface); border-color: var(--text-muted); }
    button.primary { background: var(--accent); border-color: var(--accent); }
    button.primary:hover { opacity: 0.9; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      padding: 1rem 2rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    
    .stat { text-align: center; }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    
    main { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    
    .filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.5rem;
      background: var(--surface);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    
    .filter-group label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    
    .filter-group select {
      padding: 0.25rem 0.5rem;
      border: none;
      background: transparent;
    }
    
    .filter-pills {
      display: flex;
      gap: 0.375rem;
      flex-wrap: wrap;
    }
    
    .pill {
      padding: 0.25rem 0.625rem;
      border-radius: 12px;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .pill:hover { border-color: var(--text-muted); }
    .pill.active { background: var(--accent); border-color: var(--accent); color: white; }
    .pill.active.success { background: var(--success); border-color: var(--success); }
    .pill.active.error { background: var(--error); border-color: var(--error); }
    .pill.active.info { background: var(--info); border-color: var(--info); }
    
    .timeline { position: relative; }
    
    .event {
      display: grid;
      grid-template-columns: 80px 32px 1fr;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
      align-items: start;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .event-time {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
      padding-top: 0.25rem;
    }
    
    .event-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      background: var(--surface);
      border: 2px solid var(--border);
      flex-shrink: 0;
    }
    
    .event-icon.tool { border-color: var(--info); }
    .event-icon.error { border-color: var(--error); }
    .event-icon.model { border-color: var(--success); }
    .event-icon.message { border-color: var(--accent); }
    
    .event-content { min-width: 0; }
    
    .event-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .event-action {
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .event-badge {
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 8px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .event-badge.success { background: rgba(63, 185, 80, 0.15); color: var(--success); }
    .event-badge.error { background: rgba(248, 81, 73, 0.15); color: var(--error); }
    .event-badge.info { background: rgba(88, 166, 255, 0.15); color: var(--info); }
    .event-badge.start { background: rgba(255, 107, 53, 0.15); color: var(--accent); }
    
    .event-agent {
      font-size: 0.7rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
    }
    
    .event-details {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-family: 'SF Mono', Monaco, monospace;
      margin-top: 0.375rem;
      background: var(--bg);
      padding: 0.5rem;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .event-meta {
      display: flex;
      gap: 1rem;
      margin-top: 0.375rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    
    .event-meta span { display: flex; align-items: center; gap: 0.25rem; }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }
    
    #status {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    
    .pulse.error { background: var(--error); }
    .pulse.warn { background: var(--accent); }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .load-more {
      text-align: center;
      padding: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>ü¶û Activity Feed</h1>
    <div class="controls">
      <select id="agentSelect"><option value="">All Agents</option></select>
      <select id="toolSelect"><option value="">All Tools</option></select>
      <button id="refreshBtn">‚Üª Refresh</button>
    </div>
  </header>
  
  <div class="stats">
    <div class="stat">
      <div class="stat-value" id="totalEvents">-</div>
      <div class="stat-label">Events</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="toolCalls">-</div>
      <div class="stat-label">Tool Calls</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="errorCount">-</div>
      <div class="stat-label">Errors</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="totalTokens">-</div>
      <div class="stat-label">Tokens</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="totalCost">-</div>
      <div class="stat-label">Cost</div>
    </div>
  </div>
  
  <main>
    <div class="filters">
      <div class="filter-pills" id="typeFilters">
        <button class="pill active" data-type="">All</button>
        <button class="pill" data-type="tool">üîß Tools</button>
        <button class="pill" data-type="model">üß† Model</button>
        <button class="pill" data-type="error">‚ùå Errors</button>
      </div>
      <div class="filter-pills" id="statusFilters">
        <button class="pill active" data-status="">Any Status</button>
        <button class="pill success" data-status="success">‚úì Success</button>
        <button class="pill error" data-status="error">‚úó Error</button>
        <button class="pill info" data-status="start">‚è≥ Start</button>
      </div>
    </div>
    
    <div class="timeline" id="timeline">
      <div class="empty-state">
        <p>Loading activity...</p>
      </div>
    </div>
    
    <div class="load-more">
      <button id="loadMoreBtn" style="display:none">Load More</button>
    </div>
  </main>
  
  <div id="status">
    <span class="pulse" id="statusPulse"></span>
    <span id="statusText">Connecting...</span>
  </div>

  <script>
    const API_URL = 'http://localhost:8742';
    
    let events = [];
    let filters = { type: '', status: '', agent: '', tool: '' };
    let limit = 100;
    
    const icons = { tool: 'üîß', error: '‚ùå', model: 'üß†', message: 'üí¨' };
    
    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    
    function formatNumber(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toString();
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    function truncate(str, len = 200) {
      if (!str) return '';
      return str.length > len ? str.slice(0, len) + '...' : str;
    }
    
    function renderEvent(e) {
      const icon = icons[e.type] || '‚ö°';
      const details = e.params ? JSON.stringify(e.params, null, 2) : e.result;
      const hasTokens = e.tokens?.total > 0;
      const hasCost = e.cost > 0;
      
      return `
        <div class="event" data-type="${e.type}" data-status="${e.status}">
          <div class="event-time">${formatTime(e.ts)}</div>
          <div class="event-icon ${e.type}">${icon}</div>
          <div class="event-content">
            <div class="event-header">
              <span class="event-action">${e.action}</span>
              <span class="event-badge ${e.status}">${e.status}</span>
              ${e.agentId ? `<span class="event-agent">${e.agentId}</span>` : ''}
              ${e.model ? `<span class="event-agent">${e.model}</span>` : ''}
            </div>
            ${details ? `<div class="event-details">${escapeHtml(truncate(details, 300))}</div>` : ''}
            ${hasTokens || hasCost ? `
              <div class="event-meta">
                ${hasTokens ? `<span>üé´ ${formatNumber(e.tokens.total)} tokens</span>` : ''}
                ${hasCost ? `<span>üí∞ $${e.cost.toFixed(4)}</span>` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    function render() {
      const filtered = events.filter(e => {
        if (filters.type && e.type !== filters.type) return false;
        if (filters.status && e.status !== filters.status) return false;
        if (filters.agent && e.agentId !== filters.agent) return false;
        if (filters.tool && e.action !== filters.tool) return false;
        return true;
      });
      
      const timeline = document.getElementById('timeline');
      
      if (filtered.length === 0) {
        timeline.innerHTML = `<div class="empty-state"><p>No events match your filters</p></div>`;
        return;
      }
      
      timeline.innerHTML = filtered.slice(0, limit).map(renderEvent).join('');
      
      document.getElementById('loadMoreBtn').style.display = 
        filtered.length > limit ? 'inline-block' : 'none';
    }
    
    async function fetchEvents() {
      const statusText = document.getElementById('statusText');
      const statusPulse = document.getElementById('statusPulse');
      
      statusText.textContent = 'Fetching...';
      
      try {
        const params = new URLSearchParams({ limit: '500' });
        if (filters.agent) params.set('agent', filters.agent);
        
        const res = await fetch(`${API_URL}/api/activity?${params}`, {
          signal: AbortSignal.timeout(5000)
        });
        
        if (!res.ok) throw new Error('API error');
        
        events = await res.json();
        statusText.textContent = `Live ¬∑ ${events.length} events`;
        statusPulse.className = 'pulse';
        render();
      } catch (err) {
        statusText.textContent = 'API offline';
        statusPulse.className = 'pulse error';
        console.error('Fetch error:', err);
      }
    }
    
    async function fetchStats() {
      try {
        const res = await fetch(`${API_URL}/api/stats`, { signal: AbortSignal.timeout(3000) });
        if (!res.ok) return;
        
        const stats = await res.json();
        
        document.getElementById('totalEvents').textContent = formatNumber(stats.total);
        document.getElementById('toolCalls').textContent = formatNumber(stats.byType?.tool || 0);
        document.getElementById('errorCount').textContent = formatNumber(stats.errors);
        document.getElementById('totalTokens').textContent = formatNumber(stats.totalTokens);
        document.getElementById('totalCost').textContent = stats.totalCost > 0 
          ? '$' + stats.totalCost.toFixed(2) 
          : '-';
      } catch {}
    }
    
    async function fetchFilters() {
      try {
        const [agentsRes, toolsRes] = await Promise.all([
          fetch(`${API_URL}/api/agents`, { signal: AbortSignal.timeout(2000) }),
          fetch(`${API_URL}/api/tools`, { signal: AbortSignal.timeout(2000) })
        ]);
        
        if (agentsRes.ok) {
          const agents = await agentsRes.json();
          const select = document.getElementById('agentSelect');
          agents.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a;
            opt.textContent = a;
            select.appendChild(opt);
          });
        }
        
        if (toolsRes.ok) {
          const tools = await toolsRes.json();
          const select = document.getElementById('toolSelect');
          tools.filter(t => t !== 'result' && t !== 'usage').forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            select.appendChild(opt);
          });
        }
      } catch {}
    }
    
    // Event listeners
    document.querySelectorAll('#typeFilters .pill').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#typeFilters .pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filters.type = btn.dataset.type;
        render();
      });
    });
    
    document.querySelectorAll('#statusFilters .pill').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#statusFilters .pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filters.status = btn.dataset.status;
        render();
      });
    });
    
    document.getElementById('agentSelect').addEventListener('change', (e) => {
      filters.agent = e.target.value;
      fetchEvents();
    });
    
    document.getElementById('toolSelect').addEventListener('change', (e) => {
      filters.tool = e.target.value;
      render();
    });
    
    document.getElementById('refreshBtn').addEventListener('click', () => {
      fetchEvents();
      fetchStats();
    });
    
    document.getElementById('loadMoreBtn').addEventListener('click', () => {
      limit += 100;
      render();
    });
    
    // Initialize
    fetchFilters();
    fetchEvents();
    fetchStats();
    
    // Auto-refresh every 10s
    setInterval(() => {
      fetchEvents();
      fetchStats();
    }, 10000);
  </script>
</body>
</html>
